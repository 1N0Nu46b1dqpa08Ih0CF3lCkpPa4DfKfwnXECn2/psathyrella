<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE-edge">
    <meta name="viewport" content="width-device-width, initial-scale=1.0">
    <title>Microphone animations</title>
    <style>*{
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}
body {
    overflow: hidden;
}
    canvas {
    background: black;
}
</style>
    <script>class Microphone {
    constructor(){
        this.initialized = false;
        navigator.mediaDevices.getUserMedia({audio:true})
        .then(function(stream){
            this.audioContext = new AudioContext();
            this.microphone = this.audioContext.createMediaStreamSource(stream);
            this.analyser = this.audioContext.createAnalyser();
            this.analyser.fftSize = 512;
            const bufferLength = this.analyser.frequencyBinCount;
            this.dataArray = new Uint8Array(bufferLength);
            this.microphone.connect(this.analyser);
            this.initialized = true;
        }.bind(this)).catch(function(err){
            alert(err);
        });
    }
    getSamples(){
        this.analyser.getByteTimeDomainData(this.dataArray);
        let normSamples = [...this.dataArray].map(e => e/128 - 1);
        return normSamples;
    }
    getVolume(){
        this.analyser.getByteTimeDomainData(this.dataArray);
        let normSamples = [...this.dataArray].map(e => e/128 - 1);
        let sum = 0;
        for (let i = 0; i < normSamples.length; i++){
            sum += normSamples[i] * normSamples[i];
        }
        let volume = Math.sqrt(sum / normSamples.length);
        return volume;
    }
}
const microphone = new Microphone();</script>
    <script>function main(){
    var canvas = document.getElementById('myCanvas');
    var ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    var audio = new Audio('https://docs.google.com/uc?export=download&id=12u88aiAwgKnCXaIhzNzFJb1T0daGfuTe');
    class Bar {
        constructor(x, y, width, height, color, index){
            this.x = x;
            this.y = y;
            this.width = width;
            this.height = height;
            this.color = color;
            this.index = index;
        }
        update(micInput){
            const sound = micInput * 1000;
            if (sound > this.height){
                this.height = sound;
            } else {
                this.height -= this.height * 0.2;
            }
        }
        draw(context, volume){
            context.strokeStyle = this.color;
            context.save();

            context.translate(0, 0);
            context.rotate(this.index * 0.2 + 1);
            context.scale(this.index / 256 * (1.3 + volume), 1.5 + volume * 0.2);
            
            context.beginPath();
            context.moveTo(this.x, this.y);
            context.lineTo(this.y, this.height * 1.4);
            context.stroke();
            context.strokeRect(this.x, this.y, this.height/1.6, this.height);
            context.restore();
        }
    }
    const microphone = new Microphone();
    let bars = [];
    let barWidth = canvas.width/256;
    function createBars(){
        for (let i = 0; i < 256; i++){
            let color = 'hsl(' + i*45*Math.sin((i * 2)) + ',' + 50+100*Math.sin(i) +'%, 50%)';
            bars.push(new Bar(0, i * 1.50, 10, 50, color, i));
        }
    }
    createBars();
    let angle = 0;
    
    function animate(){
        if (microphone.initialized){
            audio.play();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // generates audio from microphone
            const samples = microphone.getSamples();
            const volume = microphone.getVolume();
            // animate bars based on microphone
            angle -= 0.1 + volume * 0.1;
            ctx.save();
            ctx.translate(canvas.width/2, canvas.height/2);
            ctx.rotate(angle + Math.sin(angle));
            bars.forEach(function(bar, i){
                bar.update(samples[i]);
                bar.draw(ctx, volume);
            });
            ctx.restore();
        }
        requestAnimationFrame(animate);
    }
    animate();
    window.onresize = function(event){
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
}</script>
</head>
<body onload="main()">
    <canvas id="myCanvas"></canvas>
</body>
</html>